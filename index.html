<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecruitPro | Full System Prototype</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --admin: #ff6b6b; --recruiter: #4dabf7; --candidate: #51cf66; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .auth-wrapper { height: 100vh; background: #1a1a2e; color: white; }
        .sidebar { height: 100vh; background: #212529; color: white; position: fixed; }
        .main-content { margin-left: 16.66667%; padding: 2rem; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); margin-bottom: 1.5rem; }
        .nav-link { color: #ced4da; cursor: pointer; }
        .nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .match-badge { background: #e7f5ff; color: #1971c2; font-weight: bold; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .status-pill { font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 12px; }
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="text-center">
        <div class="spinner-border text-primary mb-2"></div>
        <p>Initializing Recruitment Database...</p>
    </div>
</div>

<div id="login-section" class="auth-wrapper d-flex align-items-center justify-content-center d-none">
    <div class="card p-5 text-dark" style="width: 400px; border-radius: 15px;">
        <h3 class="text-center mb-4">RecruitPro</h3>
        <div class="d-grid gap-3">
            <button onclick="mockLogin(1, 'Admin')" class="btn btn-danger">Login as Admin</button>
            <button onclick="mockLogin(2, 'Jane Recruiter')" class="btn btn-primary">Login as Recruiter</button>
            <button onclick="mockLogin(3, 'Ayaan Candidate')" class="btn btn-success">Login as Candidate</button>
        </div>
    </div>
</div>

<div id="app-section" class="container-fluid d-none">
    <div class="row">
        <nav class="col-md-2 sidebar p-3">
            <h4 class="mb-4 text-center">RecruitPro</h4>
            <ul class="nav flex-column" id="side-menu"></ul>
            <hr>
            <button onclick="location.reload()" class="btn btn-outline-light btn-sm w-100">Logout</button>
        </nav>

        <main class="col-md-10 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="view-title">Dashboard</h2>
                <div id="user-badge" class="badge bg-dark p-2"></div>
            </div>
            <div id="main-view"></div>
        </main>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

<script>
let db;
let currentUser = { id: null, role: null, name: "" };

// --- 1. DATABASE INITIALIZATION ---
async function init() {
    const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
    db = new SQL.Database();
    
    // Create Tables, Views, Triggers, and Seed Data
    db.run(`
        CREATE TABLE Roles (RoleID INTEGER PRIMARY KEY, RoleName TEXT);
        CREATE TABLE ApplicationStatus (StatusID INTEGER PRIMARY KEY, StatusName TEXT);
        CREATE TABLE ApplicationStatusTransitions (FromStatusID INT, ToStatusID INT);
        
        CREATE TABLE Users (UserID INTEGER PRIMARY KEY, Username TEXT, RoleID INT);
        CREATE TABLE Candidates (CandidateID INTEGER PRIMARY KEY, UserID INT, FullName TEXT, YearsOfExperience INT, Location TEXT);
        CREATE TABLE JobPostings (JobID INTEGER PRIMARY KEY, JobTitle TEXT, Location TEXT, MinExperience INT, Vacancies INT, IsActive INT DEFAULT 1);
        CREATE TABLE JobSkills (JobID INT, SkillID INT, IsMandatory INT, MinProficiency INT);
        CREATE TABLE Skills (SkillID INTEGER PRIMARY KEY, SkillName TEXT);
        CREATE TABLE CandidateSkills (CandidateID INT, SkillID INT, ProficiencyLevel INT);
        CREATE TABLE Applications (ApplicationID INTEGER PRIMARY KEY, CandidateID INT, JobID INT, StatusID INT, AppliedDate DATETIME DEFAULT CURRENT_TIMESTAMP);
        CREATE TABLE InterviewSchedules (ScheduleID INTEGER PRIMARY KEY, ApplicationID INT, RecruiterID INT, InterviewStart TEXT, InterviewEnd TEXT);
        CREATE TABLE ApplicationStatusHistory (HistoryID INTEGER PRIMARY KEY, ApplicationID INT, ToStatusID INT, ChangedBy INT, Notes TEXT, ChangedAt DATETIME DEFAULT CURRENT_TIMESTAMP);
        CREATE TABLE ApplicationsArchive (ApplicationID INT, CandidateID INT, JobID INT, StatusID INT);

        -- VIEWS
        CREATE VIEW vw_CandidateMatchScore AS
        SELECT c.CandidateID, c.FullName, j.JobID, j.JobTitle, c.YearsOfExperience, 
               (c.YearsOfExperience * 10) as MatchScore
        FROM Candidates c, JobPostings j;

        CREATE VIEW vw_HiringBottlenecks AS
        SELECT s.StatusName, COUNT(a.ApplicationID) as Count 
        FROM ApplicationStatus s LEFT JOIN Applications a ON s.StatusID = a.StatusID GROUP BY s.StatusName;

        -- TRIGGER: Prevent Double Booking
        CREATE TRIGGER trg_PreventDoubleBooking BEFORE INSERT ON InterviewSchedules
        BEGIN
            SELECT CASE WHEN EXISTS (
                SELECT 1 FROM InterviewSchedules WHERE RecruiterID = NEW.RecruiterID 
                AND NEW.InterviewStart < InterviewEnd AND NEW.InterviewEnd > InterviewStart
            ) THEN RAISE(ABORT, 'Recruiter is already booked at this time!') END;
        END;

        -- SEED DATA
        INSERT INTO Roles VALUES (1,'Admin'),(2,'Recruiter'),(3,'Candidate');
        INSERT INTO ApplicationStatus VALUES (1,'Applied'),(2,'Screening'),(3,'Interview'),(4,'Hired'),(5,'Rejected'),(6,'Withdrawn');
        INSERT INTO ApplicationStatusTransitions VALUES (1,2),(2,3),(3,4),(3,5),(1,6),(2,6),(3,6);
        INSERT INTO Users VALUES (1,'admin_user',1),(2,'recruiter_jane',2),(3,'candidate_ayaan',3);
        INSERT INTO Candidates VALUES (1,3,'Ayaan Candidate', 5, 'Dhaka');
        INSERT INTO JobPostings VALUES (1,'Senior Dev','Dhaka',4, 2, 1), (2,'Junior QA','Remote',1, 5, 1);
    `);

    document.getElementById('loading-screen').classList.add('d-none');
    document.getElementById('login-section').classList.remove('d-none');
}

// --- 2. AUTH & ROUTING ---
function mockLogin(role, name) {
    currentUser = { id: role, role: role, name: name };
    document.getElementById('login-section').classList.add('d-none');
    document.getElementById('app-section').classList.remove('d-none');
    document.getElementById('user-badge').innerText = `${name} (${role === 1 ? 'Admin' : role === 2 ? 'Recruiter' : 'Candidate'})`;
    renderMenu();
    goHome();
}

function renderMenu() {
    const menu = document.getElementById('side-menu');
    let items = '';
    if (currentUser.role === 1) {
        items = `<li class="nav-link p-2" onclick="goHome()">Analytics</li>
                 <li class="nav-link p-2" onclick="renderAdminConfig()">System Config</li>`;
    } else if (currentUser.role === 2) {
        items = `<li class="nav-link p-2" onclick="goHome()">Candidate Matching</li>
                 <li class="nav-link p-2" onclick="renderPostJob()">Post a Job</li>`;
    } else {
        items = `<li class="nav-link p-2" onclick="goHome()">Browse Jobs</li>
                 <li class="nav-link p-2" onclick="renderMyApps()">My Applications</li>`;
    }
    menu.innerHTML = items;
}

function goHome() {
    if (currentUser.role === 1) renderAdminDash();
    else if (currentUser.role === 2) renderRecruiterDash();
    else renderCandidateDash();
}

// --- 3. RECRUITER FEATURES ---
function renderRecruiterDash() {
    document.getElementById('view-title').innerText = "Top Candidate Matches";
    const res = db.exec("SELECT * FROM vw_CandidateMatchScore");
    let html = `<table class="table bg-white"><thead><tr><th>Candidate</th><th>Job</th><th>Exp</th><th>Score</th><th>Action</th></tr></thead><tbody>`;
    if (res[0]) {
        res[0].values.forEach(row => {
            html += `<tr><td>${row[1]}</td><td>${row[3]}</td><td>${row[4]}y</td><td><span class="match-badge">${row[5]}%</span></td>
            <td><button class="btn btn-sm btn-primary" onclick="scheduleInterview(${row[0]})">Schedule</button></td></tr>`;
        });
    }
    document.getElementById('main-view').innerHTML = html + `</tbody></table>`;
}

function scheduleInterview(candId) {
    const start = prompt("Enter Start Time (YYYY-MM-DD HH:MM)", "2025-01-10 10:00");
    const end = prompt("Enter End Time (YYYY-MM-DD HH:MM)", "2025-01-10 11:00");
    try {
        db.run("INSERT INTO InterviewSchedules (ApplicationID, RecruiterID, InterviewStart, InterviewEnd) VALUES (?,?,?,?)", [1, currentUser.id, start, end]);
        alert("Interview scheduled successfully!");
    } catch(e) {
        alert("SQL Error: " + e.message);
    }
}

function renderPostJob() {
    document.getElementById('main-view').innerHTML = `
        <div class="card p-4" style="max-width: 500px">
            <h4>Post New Job Posting</h4>
            <input id="jt" class="form-control mb-2" placeholder="Job Title">
            <input id="jl" class="form-control mb-2" placeholder="Location">
            <input id="jv" type="number" class="form-control mb-3" placeholder="Vacancies">
            <button class="btn btn-primary" onclick="saveJob()">Publish</button>
        </div>`;
}

function saveJob() {
    const t = document.getElementById('jt').value;
    const l = document.getElementById('jl').value;
    const v = document.getElementById('jv').value;
    db.run("INSERT INTO JobPostings (JobTitle, Location, Vacancies) VALUES (?,?,?)", [t, l, v]);
    alert("Job Published!");
    goHome();
}

// --- 4. ADMIN FEATURES ---
function renderAdminDash() {
    document.getElementById('view-title').innerText = "System Analytics";
    const res = db.exec("SELECT * FROM vw_HiringBottlenecks");
    let html = `<div class="row">`;
    if (res[0]) {
        res[0].values.forEach(row => {
            html += `<div class="col-md-3"><div class="card p-3 text-center"><h6>${row[0]}</h6><h2>${row[1]}</h2></div></div>`;
        });
    }
    document.getElementById('main-view').innerHTML = html + `</div>`;
}

function renderAdminConfig() {
    document.getElementById('main-view').innerHTML = `
        <div class="card p-4">
            <h4>Maintenance Controls</h4>
            <button class="btn btn-warning mb-2" onclick="db.run('INSERT INTO ApplicationsArchive SELECT * FROM Applications'); alert('Archived!')">Execute sp_ArchiveOldData</button>
            <button class="btn btn-secondary" onclick="db.run('UPDATE Candidates SET FullName = \'Anonymized\''); alert('GDPR Anonymization Complete!')">Execute sp_AnonymizeCandidates</button>
        </div>`;
}

// --- 5. CANDIDATE FEATURES ---
function renderCandidateDash() {
    document.getElementById('view-title').innerText = "Available Careers";
    const res = db.exec("SELECT * FROM JobPostings WHERE IsActive = 1");
    let html = `<div class="row">`;
    res[0].values.forEach(row => {
        html += `<div class="col-md-4"><div class="card p-3"><h5>${row[1]}</h5><p>${row[2]}</p>
        <button class="btn btn-outline-success" onclick="apply(${row[0]})">Apply Now</button></div></div>`;
    });
    document.getElementById('main-view').innerHTML = html + `</div>`;
}

function apply(jobId) {
    try {
        db.run("INSERT INTO Applications (CandidateID, JobID, StatusID) VALUES (1, ?, 1)", [jobId]);
        alert("Applied! Matching score calculated.");
    } catch(e) { alert("Already applied for this job."); }
}

function renderMyApps() {
    const res = db.exec("SELECT a.ApplicationID, j.JobTitle, s.StatusName FROM Applications a JOIN JobPostings j ON a.JobID = j.JobID JOIN ApplicationStatus s ON a.StatusID = s.StatusID");
    let html = `<ul class="list-group">`;
    if (res[0]) {
        res[0].values.forEach(row => {
            html += `<li class="list-group-item d-flex justify-content-between">${row[1]} <span>${row[2]}</span>
            <button class="btn btn-sm btn-danger" onclick="db.run('UPDATE Applications SET StatusID=6 WHERE ApplicationID=${row[0]}'); renderMyApps()">Withdraw</button></li>`;
        });
    }
    document.getElementById('main-view').innerHTML = html + `</ul>`;
}

init();
</script>
</body>
</html>
