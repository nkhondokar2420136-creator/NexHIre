<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production-Ready RMS Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        /* Modern UI Styling */
        :root { --primary: #667eea; --secondary: #764ba2; --admin: #ff6b6b; --recruiter: #4dabf7; --candidate: #51cf66; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Dashboards */
        .dashboard { display: none; padding-top: 20px; }
        .dashboard.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navigation & Headers */
        header { background: white; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .badge { padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; font-size: 12px; }

        /* Grid & Cards */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: white; padding: 20px; border-radius: 15px; cursor: pointer; transition: 0.3s; border-bottom: 4px solid var(--primary); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }

        /* Tables & Reports */
        .report-section { background: white; padding: 25px; border-radius: 15px; margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; text-align: left; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Forms & Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .view-selector { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="loginScreen" class="container" style="text-align: center; margin-top: 100px;">
    <h1>üéØ Pro-Recruitment System</h1>
    <div style="max-width: 400px; margin: 20px auto; background: white; padding: 40px; border-radius: 20px;">
        <input type="email" id="loginEmail" placeholder="Email (e.g., admin@company.com)" style="width: 100%; padding: 10px; margin-bottom: 10px;">
        <button onclick="login()" class="btn btn-primary" style="width: 100%;">Sign In</button>
    </div>
</div>

<div id="adminDashboard" class="dashboard container">
    <header>
        <h2>Admin Panel</h2>
        <div><span class="badge" style="background:var(--admin)">ADMIN</span> <button onclick="location.reload()">Logout</button></div>
    </header>
    <div class="menu-grid">
        <div class="card" onclick="runArchiveProcess()"><h3>üì¶ Run Archiving</h3><p>sp_ArchiveOldData</p></div>
        <div class="card" onclick="showAdminSection('reports')"><h3>üìä 16 Analytical Views</h3><p>System-wide Reports</p></div>
        <div class="card" onclick="showAdminSection('audit')"><h3>üîí Audit Trail</h3><p>Trigger Logs</p></div>
    </div>
    <div id="adminViewSpace" class="report-section" style="display:none">
        <select id="reportPicker" class="view-selector" onchange="loadView(this.value)">
            <option value="">-- Choose a View (16 available) --</option>
            <option value="vw_ApplicationFunnel">1. Application Funnel</option>
            <option value="vw_CandidateMatchScore">2. Match Scores</option>
            <option value="vw_TimeToHire">3. Time to Hire (Detailed)</option>
            <option value="vw_AverageTimeToHire">4. Average Time to Hire</option>
            <option value="vw_HireRatePerJob">5. Hire Rate Per Job</option>
            <option value="vw_RecruiterPerformance">6. Recruiter Stats</option>
            <option value="vw_Bias_Location">7. Location Bias Check</option>
            <option value="vw_Bias_Experience">8. Experience Bias Check</option>
            <option value="vw_InterviewScoreVsDecision">9. Scores vs Decisions</option>
            <option value="vw_InterviewerConsistency">10. Interviewer Variance</option>
            <option value="vw_SkillGapAnalysis">11. Skill Gap Analysis</option>
            <option value="vw_CandidateEngagement">12. Engagement Rate</option>
            <option value="vw_HiringBottlenecks">13. Bottleneck Detector</option>
            <option value="vw_RejectionAnalysis">14. Rejection Reasons</option>
            <option value="vw_VacancyUtilization">15. Vacancy Utilization</option>
            <option value="vw_SilentRejections">16. Silent Rejections (>30 Days)</option>
        </select>
        <div id="tableView"></div>
    </div>
</div>

<div id="recruiterDashboard" class="dashboard container">
    <header>
        <h2>Recruiter Console</h2>
        <div><span class="badge" style="background:var(--recruiter)">RECRUITER</span> <button onclick="location.reload()">Logout</button></div>
    </header>
    <div class="menu-grid">
        <div class="card" onclick="loadRecruiterApps()"><h3>üìù Manage Applications</h3><p>Status & Hiring</p></div>
    </div>
    <div id="recruiterViewSpace" class="report-section"></div>
</div>

<script>
    let db;
    let currentUser = null;

    async function init() {
        const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
        const data = await fetch('recruitment.db').then(res => res.arrayBuffer());
        db = new SQL.Database(new Uint8Array(data));
        console.log("Database initialized with Triggers and Views");
    }

    // --- PROCEDURE EMULATION (The JS Logic) ---

    // Port of sp_UpdateApplicationStatus
    function jsUpdateStatus(appId, newStatusId, notes) {
        try {
            // Check current status for transition validation
            const current = db.exec(`SELECT StatusID FROM Applications WHERE ApplicationID = ${appId}`)[0].values[0][0];
            
            // Terminal state check (Hired/Rejected)
            if (current === 4 || current === 5) throw "Cannot modify a terminal state.";

            db.run(`UPDATE Applications SET StatusID = ${newStatusId}, StatusChangedAt = datetime('now') WHERE ApplicationID = ${appId}`);
            db.run(`INSERT INTO ApplicationStatusHistory (ApplicationID, FromStatusID, ToStatusID, ChangedBy, Notes) 
                    VALUES (${appId}, ${current}, ${newStatusId}, ${currentUser.id}, '${notes}')`);
            
            alert("Status Updated!");
            loadRecruiterApps();
        } catch (e) { alert("Error: " + e); }
    }

    // Port of sp_HireCandidate
    function jsHireCandidate(appId, jobId) {
        try {
            db.run("BEGIN TRANSACTION");
            
            // Check vacancies
            const vac = db.exec(`SELECT Vacancies FROM JobPostings WHERE JobID = ${jobId}`)[0].values[0][0];
            if (vac <= 0) throw "No vacancies remaining!";

            // Update App to 'Hired' (Status 4)
            db.run(`UPDATE Applications SET StatusID = 4 WHERE ApplicationID = ${appId}`);
            
            // Decrement Vacancy
            db.run(`UPDATE JobPostings SET Vacancies = Vacancies - 1 WHERE JobID = ${jobId}`);

            db.run("COMMIT");
            alert("Candidate Hired Successfully!");
            loadRecruiterApps();
        } catch (e) {
            db.run("ROLLBACK");
            alert("Hire Failed: " + e);
        }
    }

    // Port of sp_ArchiveOldData
    function runArchiveProcess() {
        db.run(`UPDATE JobPostings SET IsDeleted = 1 WHERE CreatedAt < date('now', '-6 months')`);
        alert("Archiving Complete (Soft Delete applied to records > 6 months)");
    }

    // --- UI LOGIC ---

    function login() {
        const email = document.getElementById('loginEmail').value;
        const res = db.exec(`SELECT u.UserID, u.Username, u.RoleID FROM Users u WHERE u.Email = '${email}'`);
        
        if (res.length > 0) {
            const d = res[0].values[0];
            currentUser = { id: d[0], name: d[1], role: d[2] };
            document.getElementById('loginScreen').style.display = 'none';
            if (d[2] === 1) document.getElementById('adminDashboard').classList.add('active');
            else if (d[2] === 2) document.getElementById('recruiterDashboard').classList.add('active');
        } else { alert("Account not found."); }
    }

    function showAdminSection(type) {
        document.getElementById('adminViewSpace').style.display = 'block';
    }

    function loadView(viewName) {
        if (!viewName) return;
        const res = db.exec(`SELECT * FROM ${viewName} LIMIT 20`);
        renderTable(res[0], 'tableView');
    }

    function loadRecruiterApps() {
        const res = db.exec(`SELECT a.ApplicationID, c.FullName, j.JobTitle, s.StatusName, a.JobID 
                             FROM Applications a 
                             JOIN Candidates c ON a.CandidateID = c.CandidateID
                             JOIN JobPostings j ON a.JobID = j.JobID
                             JOIN ApplicationStatus s ON a.StatusID = s.StatusID`);
        
        let html = '<h3>Active Applications</h3><table><tr><th>Candidate</th><th>Job</th><th>Status</th><th>Actions</th></tr>';
        res[0].values.forEach(v => {
            html += `<tr>
                <td>${v[1]}</td><td>${v[2]}</td><td>${v[3]}</td>
                <td>
                    <button onclick="jsUpdateStatus(${v[0]}, 3, 'Moved to Interview')">Interview</button>
                    <button onclick="jsHireCandidate(${v[0]}, ${v[4]})" style="color:green">HIRE</button>
                </td>
            </tr>`;
        });
        document.getElementById('recruiterViewSpace').innerHTML = html + '</table>';
    }

    function renderTable(data, targetId) {
        if (!data) { document.getElementById(targetId).innerHTML = "No data found for this view."; return; }
        let html = '<table><thead><tr>';
        data.columns.forEach(c => html += `<th>${c}</th>`);
        html += '</tr></thead><tbody>';
        data.values.forEach(row => {
            html += '<tr>';
            row.forEach(val => html += `<td>${val === null ? '-' : val}</td>`);
            html += '</tr>';
        });
        document.getElementById(targetId).innerHTML = html + '</tbody></table>';
    }

    window.onload = init;
</script>
</body>
</html>
